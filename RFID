from evdev import InputDevice
from select import select
from twilio.rest import Client

import RPi.GPIO as GPIO
import time
import random

GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)
GPIO.setup(13,GPIO.OUT)

account_sid = "AC01a433c38cc73f0e0730293dd860d20f"
auth_token = "29d9fc843d53488e136dbea18d6f8607"

client = Client(account_sid, auth_token)

rfid_read = ""
keys = "X^1234567890XXXXqwertzuiopXXXXasdfghjklXXXXXyxcvbnmXXXXXXXXXXXXXXXXXXXXXXX"
dev = InputDevice('/dev/input/event0')




# two_factor_auth - Generates a random 4-digit code
#
#
def two_factor_auth():
	#Generate code string
	code = ""
	list = random.sample(range(10), 4)
	for x in list:
		code += str(x)
		
	#Send code to user via sms
	message = client.messages.create(body= code, from_='+19705985806', to='+16192618153')
	
	#Give user three attempts to provide correct code
	userInput = input('Enter code: ')
	
	for i in range(3):
		userInput = input("Enter code: ")
		if userInput == code:
			return True
		elif i == 2:
			return False
		else:
			print("Invalid code, please try again. You have " + str(2-i) + " attempts remaining.")
			
	#print(code)
	return True

# initial message:
print("Please scan an authorized chip or card: ")

while True:
	r, w, x = select([dev], [], [])
	for event in dev.read():
		if event.type == 1 and event.value == 1:
			# Check if 'newline' character entered, indicating end of 
			#rfid tag value
			if event.code == 28:
				if rfid_read == "06955249":
					#Two-factor authentication
					if (two_factor_auth() == False):
						print("Access Denied.")
					else:
						print("Door unlocked.")
						GPIO.output(13, GPIO.HIGH)
						time.sleep(5)
						GPIO.output(13,GPIO.LOW)
						print("Door is now locked.")
				else:
					print("Access Denied.")
				rfid_read = ""
			else:
				rfid_read += keys[event.code]

